<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sunshine RS-CIT Practice ChatBot</title>
  <style>
    :root{
      --primary:#1976d2;
      --accent:#ef5350;
      --bg:#f7f8fa;
      --card:#ffffff;
      --muted:#6b7280;
      --success:#22c55e;
      --danger:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Arial,Helvetica,sans-serif;color:#111}
    .wrap{max-width:900px;margin:24px auto;padding:12px}
    .panel{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08);overflow:hidden;position:relative}
    /* Start Screen */
    .start-screen{padding:28px 20px;text-align:center}
    .start-screen h2{margin:0 0 6px;font-size:26px;color:var(--primary)}
    .start-screen p{margin:6px 0;color:#374151}
    .start-screen button{margin-top:14px;background:var(--primary);color:#fff;border:none;border-radius:10px;padding:12px 18px;font-size:16px;cursor:pointer}
    .start-screen button:hover{filter:brightness(.95)}
    /* Chat Window */
    .chat-window{display:flex;flex-direction:column;height:70vh;min-height:520px}
    .bar{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid #eef0f3;background:#fafbfc}
    .bar-title{font-weight:700;color:#0f172a}
    .bar-user{font-size:13px;color:var(--muted)}
    #chatMessages{flex:1;overflow:auto;padding:16px;background:#f9fafb}
    .messages > div{max-width:92%}
    .bot-msg,.user-msg,.question-msg,.correct-answer{
      margin:8px 0;padding:10px 12px;border-radius:12px;line-height:1.4
    }
    .bot-msg{background:#e8f1fe;border:1px solid #d4e6ff}
    .bot-msg.welcome{background:#e6fffa;border-color:#baf3e6}
    .bot-msg.correct{background:#eaffea;border-color:#c5f2c5}
    .bot-msg.wrong{background:#ffecec;border-color:#ffd3d3}
    .user-msg{background:#fff;border:1px solid #e5e7eb;align-self:flex-end}
    .question-msg{background:#fff7ed;border:1px solid #ffedd5;font-weight:700}
    .correct-answer{background:#ecfeff;border:1px solid #cffafe}
    .buttons{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;padding:12px;border-top:1px solid #eef0f3;background:#fff}
    .buttons button{padding:12px;border:none;border-radius:10px;background:var(--primary);color:#fff;font-weight:600;cursor:pointer}
    .buttons button:hover{filter:brightness(.95)}
    .celebration-card{background:#fff;border:1px solid #e5e7eb;border-left:6px solid var(--primary);padding:12px 14px;border-radius:12px;margin:10px 0}
    .celebration-card.suspense{border-left-color:#f59e0b;background:#fff7ed}
    /* Confetti Layer */
    #confetti{pointer-events:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:50}
    /* Payment/Errors */
    .notice{padding:18px;text-align:center}
    .notice h3{margin:0 0 8px;color:#111827}
    .notice .bad{color:var(--danger);font-weight:700}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;background:#eef2ff;color:#3730a3}
    .footer-note{font-size:12px;color:var(--muted);margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="chatBotArea" class="panel">
      <!-- filled by JS -->
    </div>
  </div>
  <div id="confetti"></div>

  <script>
/* ================== CONFIG & STATE ================== */
const backendUrl = "https://script.google.com/macros/s/AKfycbx4Bx-4lSDrBsB1_i6E4reHBiKgKP1zhtVWryVoN8L90Bx72JHSNPaA12aV__fYbRA-/exec";

const ChatBot = (() => {
  let questions = [];
  let currentIndex = 0;
  let score = 0;
  let attempted = 0;
  let correct = 0;
  let userName = "Student";
  let fullName = "";

  /* ============ PUBLIC ENTRY: RENDER START SCREEN ============ */
  function openChatBotMode() {
    const area = document.getElementById('chatBotArea');
    area.innerHTML = `
      <div class="start-screen">
        <div class="pill">Practice Mode</div>
        <h2>üåû Welcome to Sunshine Skill Bot!</h2>
        <p>35 Random Questions | Har Baar Naya Challenge!</p>
        <p>‡§Ö‡§¨ ‡§π‡•ã‡§ó‡•Ä ‡§Ü‡§®‡•á ‡§µ‡§æ‡§≤‡•á RS-CIT ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡•Ä ‡§∂‡§æ‡§®‡§¶‡§æ‡§∞ ‡§§‡•à‡§Ø‡§æ‡§∞‡•Ä!</p>
        <button id="startPracticeBtn">üöÄ Start Practice</button>
        <div class="footer-note">Tip: A, B, C, D buttons se jawab dijiye ‚Äî sahi par +2 marks!</div>
      </div>
    `;
    document.getElementById('startPracticeBtn').onclick = loadChatWindow;
  }

  /* ============ RENDER CHAT WINDOW & BEGIN ============ */
  function loadChatWindow() {
    const area = document.getElementById('chatBotArea');
    area.innerHTML = `
      <div class="chat-window" id="chatContainer">
        <div class="bar">
          <div class="bar-title">Sunshine RS-CIT Practice</div>
          <div class="bar-user">üë§ ${fullName || userName}</div>
        </div>
        <div id="chatMessages" class="messages"></div>
        <div id="answerButtons" class="buttons">
          <button onclick="ChatBot.chooseAnswer('A')">A</button>
          <button onclick="ChatBot.chooseAnswer('B')">B</button>
          <button onclick="ChatBot.chooseAnswer('C')">C</button>
          <button onclick="ChatBot.chooseAnswer('D')">D</button>
        </div>
      </div>
    `;
    startChatBotTest();
  }

  /* ============ BACKEND: LOAD QUESTIONS AFTER PAYMENT CHECK ============ */
  function startChatBotTest() {
    // Fetch questions from Apps Script: startChatBotSession
    const url = `${backendUrl}?action=startChatBotSession&username=${encodeURIComponent(userName)}&limit=35`;
    fetch(url)
      .then(r => r.json())
      .then(initChatBot)
      .catch(err => {
        alert("Error starting practice: " + (err?.message || err));
      });
  }

  function initChatBot(data) {
    if (!data || data.status !== 'ok' || !Array.isArray(data.questions)) {
      alert("Unable to load questions");
      return;
    }
    // Expected question format per prompt:
    // [questionText, optionA, optionB, optionC, optionD, correctOptionLetter]
    questions = data.questions;
    score = 0; attempted = 0; correct = 0; currentIndex = 0;

    showBotMessage(
      `üôè‡§∞‡§æ‡§ß‡•á ‡§∞‡§æ‡§ß‡•áüôè, ‡§¶‡•ã‡§∏‡•ç‡§§‡•ã‡§Ç<br>ü§ñ Hey Champion, ${fullName || userName}! üëã<br>
       Sunshine Bot me swagat hai ‚Äì Practice karo, marks jeeto aur RS-CIT ke liye top taiyari karo!<br>
       Aao shuru karte hain! üòâ`,
      true
    );
    askNextQuestion();
  }

  /* ============ QUESTION / ANSWER FLOW ============ */
  function askNextQuestion() {
    if (currentIndex >= questions.length) { showSummary(); return; }
    const q = questions[currentIndex];

    // Defensive: ensure array shape
    const qText = q[0] ?? '';
    const opts = [q[1], q[2], q[3], q[4]];
    const corr = (q[5] || 'A').toString().trim().toUpperCase();

    showQuestionMessage(`Q${currentIndex + 1}: ${qText}`);
    document.querySelectorAll('#answerButtons button').forEach((btn, i) => {
      btn.textContent = `${String.fromCharCode(65 + i)}. ${opts[i] ?? ''}`;
    });
  }

  function chooseAnswer(option) {
    const q = questions[currentIndex];
    const corr = (q[5] || 'A').toString().trim().toUpperCase();
    const opts = [q[1], q[2], q[3], q[4]];
    const correctText = opts[corr.charCodeAt(0) - 65] || '';
    const selectedText = opts[option.charCodeAt(0) - 65] || '';

    attempted++;
    showUserMessage(`üë§ ${fullName || userName}: ${option}. ${selectedText}`);

    if (option === corr) {
      score += 2; correct++;
      showBotMessage(`ü§ñ Wah, ${fullName || userName}! üëÜ ‡§∏‡§π‡•Ä ‡§ú‡§µ‡§æ‡§¨! (+2 Marks) | Total: ${score} Marks`, false, 'correct');
      launchConfetti();
      if (score === 28) showCelebrationCard(fullName || userName);
    } else {
      showBotMessage(`ü§ñ Oops, ${fullName || userName}! üëÜ ‡§ó‡§≤‡§§ ‡§ú‡§µ‡§æ‡§¨. | Total: ${score} Marks`, false, 'wrong');
      showCorrectAnswer(`ü§ñ ‡§∏‡§π‡•Ä ‡§ú‡§µ‡§æ‡§¨ ‡§π‡•àüëâ: ${corr}. ${correctText}`);
    }

    checkMilestones();
    currentIndex++;
    setTimeout(askNextQuestion, 1200);
  }

  function checkMilestones() {
    const marks = score;
    const correctQs = correct;

    if (marks === 42) {
      showCustomCelebration("üéâ Shabash Champion!",
        "Aapne First Division (42 Marks) hasil kar li hai ‚Äì Hard Work ka Result!<br>Ab Agla Target ‚Äì <b>Top Rank!</b> üöÄ");
    }
    else if (marks === 50) {
      showCustomCelebration("üî• Excellent!",
        "Aapne 25 Questions Correct (50 Marks) ka milestone achieve kiya hai!<br>Next Goal ‚Äì <b>30 Questions!</b> Keep Going, Winner! üåü");
    }
    else if (marks === 60) {
      showCustomCelebration("üåü Outstanding!",
        "Aapne 30 Questions Correct (60 Marks) se ek aur Level Cross kiya!<br>Ab <b>Topper List</b> ke liye Ready Raho ‚Äì Keep the Speed! üöÄ");
    }
    else if (marks === 70) {
      showCustomCelebration("üéä Incredible! Sabhi 35 Questions Sahi!",
        "Aapne Perfect Champion ban kar <b>Record Tod Diya!</b> üèÜ<br>Sabse Bada Jashn ‚Äì Claps & Cheers! üéâ");
    }
    else if (correctQs >= 31 && correctQs <= 34) {
      const suspenseLines = [
        "‚ö° Bas Thoda Sa Aur‚Ä¶ Record Tootne Wala Hai?",
        "üî• Kya Aapka Naam Topper List Mein Aane Wala Hai?",
        "üåü Sirf 1 Question Ka Fark ‚Äì Champion Ban Sakte Ho!",
        "üöÄ Focus Rakho ‚Äì Victory Pass Hi Hai!"
      ];
      const randomLine = suspenseLines[Math.floor(Math.random() * suspenseLines.length)];
      showCustomCelebration("Suspense Mode", randomLine, true);
    }
  }

  function showSummary() {
    showBotMessage(`ü§ñ Practice Complete, ${fullName || userName}!`);
    showBotMessage(`‚úî Attempted: ${attempted}<br>‚úî Correct: ${correct}<br>‚úî Marks: ${score}`);

    if (score < 50) {
      showCustomCelebration("Motivation Time!",
        "‡§π‡§∞ ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§Æ‡§æ‡§Ø‡§®‡•á ‡§∞‡§ñ‡§§‡•Ä ‡§π‡•à! üí™<br>‡§á‡§∏ ‡§¨‡§æ‡§∞ ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ 42 ‡§∏‡•á ‡§ï‡§Æ ‡§Ü‡§Ø‡§æ, ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ø‡§π‡•Ä ‡§∏‡•á ‡§∏‡•Ä‡§ñ‡§ï‡§∞ ‡§Ö‡§ó‡§≤‡•Ä ‡§¨‡§æ‡§∞ ‡§î‡§∞ ‡§Æ‡§ú‡§¨‡•Ç‡§§ ‡§µ‡§æ‡§™‡§∏‡•Ä ‡§ï‡§∞‡•ã‡•§<br>‡§π‡§æ‡§∞ ‡§Æ‡§§ ‡§Æ‡§æ‡§®‡•ã ‚Äì ‡§Ö‡§ó‡§≤‡§æ ‡§ü‡•á‡§∏‡•ç‡§ü ‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§∞‡•Ä ‡§ú‡•Ä‡§§ ‡§ï‡•Ä ‡§∂‡•Å‡§∞‡•Å‡§Ü‡§§ ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à!");
    }
    else if (score >= 50 && score <= 60) {
      showCustomCelebration("‡§∂‡§æ‡§®‡§¶‡§æ‡§∞! üéâ",
        "50+ Marks ‚Äì ‡§Ø‡§π ‡§∏‡§æ‡§¨‡§ø‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§Ü‡§™ ‡§∏‡§π‡•Ä ‡§∞‡§æ‡§π ‡§™‡§∞ ‡§π‡•ã‡•§<br>‡§Ö‡§¨ ‡§¨‡§∏ ‡§•‡•ã‡§°‡§º‡•Ä ‡§î‡§∞ ‡§Æ‡•á‡§π‡§®‡§§ ‡§∏‡•á 60+ ‡§î‡§∞ ‡§´‡§ø‡§∞ Top Scores ‡§§‡§ï ‡§™‡§π‡•Å‡§Å‡§ö ‡§∏‡§ï‡§§‡•á ‡§π‡•ã!");
    }
    else if (score >= 62 && score <= 68) {
      showCustomCelebration("‡§ï‡§Æ‡§æ‡§≤ ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ! üöÄ",
        "62+ Marks ‚Äì ‡§Ö‡§¨ ‡§Ü‡§™ Top Performers ‡§ï‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§π‡•ã‡•§<br>‡§¨‡§∏ ‡§•‡•ã‡§°‡§º‡•Ä ‡§î‡§∞ ‡§´‡•ã‡§ï‡§∏ ‡§î‡§∞ ‡§Æ‡•á‡§π‡§®‡§§ ‚Äì ‡§Ö‡§ó‡§≤‡•Ä ‡§¨‡§æ‡§∞ Perfect 70/70 ‡§Ü‡§™‡§ï‡§æ ‡§π‡•ã‡§ó‡§æ!");
    }
    else if (score === 70) {
      showCustomCelebration("üî• ‡§Ö‡§µ‡§ø‡§∂‡•ç‡§µ‡§∏‡§®‡•Ä‡§Ø! 70/70 ‚Äì ‡§Ü‡§™ ‡§π‡•à‡§Ç Sunshine Champion!",
        "‡§Ü‡§™‡§ï‡•Ä ‡§Æ‡•á‡§π‡§®‡§§, Focus ‡§î‡§∞ Dedication ‡§ï‡§æ ‡§Ø‡§π ‡§∂‡§æ‡§®‡§¶‡§æ‡§∞ ‡§®‡§§‡•Ä‡§ú‡§æ ‡§π‡•à‡•§<br>‡§Ö‡§¨ ‡§Ü‡§™ ‡§¶‡•Ç‡§∏‡§∞‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è Inspiration ‡§¨‡§® ‡§ö‡•Å‡§ï‡•á ‡§π‡•à‡§Ç ‚Äì Keep Shining! üåü");
    }

    showBotMessage(`üî• Kal fir se naye questions ke sath wapas aaiye aur streak banaiye! üåü`);
  }

  /* ============ UI HELPERS ============ */
  function showBotMessage(msg, isWelcome=false, type='') {
    const chat = document.getElementById('chatMessages');
    let extraClass = '';
    if (type === 'correct') extraClass = 'correct';
    else if (type === 'wrong') extraClass = 'wrong';
    chat.innerHTML += `<div class="bot-msg ${isWelcome ? 'welcome' : ''} ${extraClass}">${msg}</div>`;
    chat.scrollTop = chat.scrollHeight;
  }

  function showUserMessage(msg) {
    const chat = document.getElementById('chatMessages');
    chat.innerHTML += `<div class="user-msg">${msg}</div>`;
    chat.scrollTop = chat.scrollHeight;
  }

  function showQuestionMessage(msg) {
    const chat = document.getElementById('chatMessages');
    chat.innerHTML += `<div class="question-msg">${msg}</div>`;
    chat.scrollTop = chat.scrollHeight;
  }

  function showCorrectAnswer(msg) {
    const chat = document.getElementById('chatMessages');
    chat.innerHTML += `<div class="correct-answer">${msg}</div>`;
    chat.scrollTop = chat.scrollHeight;
  }

  function showCustomCelebration(title, message, isSuspense=false) {
    const chat = document.getElementById('chatMessages');
    chat.innerHTML += `
      <div class="celebration-card ${isSuspense ? 'suspense' : ''}">
        <h3>${title}</h3>
        <p>${message}</p>
      </div>`;
    chat.scrollTop = chat.scrollHeight;
    for (let i = 0; i < 2; i++) setTimeout(launchConfetti, i * 400);
  }

  function launchConfetti() {
    const confetti = document.getElementById('confetti');
    for (let i = 0; i < 16; i++) {
      const div = document.createElement('div');
      div.style.position = 'absolute';
      div.style.width = `${6 + Math.random() * 6}px`;
      div.style.height = div.style.width;
      div.style.backgroundColor = `hsl(${Math.random() * 360},100%,70%)`;
      div.style.top = '-10px';
      div.style.left = `${Math.random() * 100}%`;
      div.style.opacity = 1;
      confetti.appendChild(div);
      const fall = div.animate([
        { transform: `translateY(0) rotate(0deg)`, opacity: 1 },
        { transform: `translateY(100vh) rotate(${720 + Math.random() * 360}deg)`, opacity: 0 }
      ], { duration: 2000 + Math.random() * 1000, easing: 'ease-out' });
      fall.onfinish = () => div.remove();
    }
  }

  function showCelebrationCard(name) {
    const chat = document.getElementById('chatMessages');
    chat.innerHTML += `
      <div class="celebration-card">
        <h3>üéâ Dear ${name},</h3>
        <p>RS-CIT ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§™‡§æ‡§∏ ‡§ï‡§∞‡§®‡•á ‡§ú‡§ø‡§§‡§®‡•á Marks ‡§Ü‡§™‡§®‡•á ‡§á‡§∏ ‡§™‡•ç‡§∞‡•à‡§ï‡•ç‡§ü‡§ø‡§∏ ‡§ü‡•á‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§π‡§æ‡§∏‡§ø‡§≤ ‡§ï‡§ø‡§è!</p>
        <p style="margin-top:6px;">‡§Ö‡§¨ ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§π‡•à ‚Äì <b>‡§∏‡§¨‡§∏‡•á ‡§¨‡•á‡§π‡§§‡§∞‡•Ä‡§® Marks</b> ‡§™‡§æ‡§®‡§æ!</p>
        <p>"‡§ú‡§º‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§™‡•ç‡§∞‡•à‡§ï‡•ç‡§ü‡§ø‡§∏ = ‡§∂‡§æ‡§®‡§¶‡§æ‡§∞ ‡§∞‡§ø‡§ú‡§º‡§≤‡•ç‡§ü!" üåü</p>
        <p>"Next Level Practice = Top Result!" üåü</p>
        <p>"‡§Ö‡§¨ ‡§Ö‡§ó‡§≤‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§π‡§≤ ‡§ï‡§∞‡•á‡§Ç üëá" üåü</p>
      </div>`;
    chat.scrollTop = chat.scrollHeight;
    for (let i = 0; i < 3; i++) setTimeout(launchConfetti, i * 500);
  }

  return { openChatBotMode, loadChatWindow, chooseAnswer };
})();

/* ================== GATEKEEPER: USER & PAYMENT CHECK ================== */
(function initGate() {
  const area = document.getElementById('chatBotArea');

  const username = (localStorage.getItem("test_username") || "").trim();
  const fullname = (localStorage.getItem("test_fullname") || "").trim();

  // expose to module
  // (safe: we are not exporting setters; capture via closure by updating)
  // easiest is a tiny hack: set on module by calling its own open method after we set globals
  // but we can't directly set inside the IIFE. We'll re-bind via a small internal patch:
  Object.defineProperty(ChatBot, "_bindUser", {
    value: (u, f) => {
      // not exported; just side-channel via closure vars using eval is messy.
      // Simpler approach: we wrap ChatBot.openChatBotMode and loadChatWindow only after we set globals.
    },
    writable: false
  });

  // Show pre-check screen
  area.innerHTML = `
    <div class="notice">
      <h3>üîê Checking Access‚Ä¶</h3>
      <p class="footer-note">Please wait while we verify your account & payment status.</p>
    </div>
  `;

  if (!username) {
    area.innerHTML = `
      <div class="notice">
        <h3 class="bad">‚ùå User not found.</h3>
        <p>Please login again to start Practice ChatBot.</p>
      </div>
    `;
    return;
  }

  // Keep local copies for ChatBot closure via a light wrapper
  // We‚Äôll decorate ChatBot.openChatBotMode to inject names before render.
  let _open = ChatBot.openChatBotMode;
  ChatBot.openChatBotMode = function(){
    // patch names into closure by shadowing globals used inside module:
    // We recreate the functions with bound names by referencing window-scoped vars.
    // Simpler: set window-scoped vars consumed in module via function properties.
  };
  // Instead of internal rebinding, we‚Äôll leverage simple globals used by ChatBot:
  // Add getters the module will read (via window)
  window.__sunshine_user__ = username;
  window.__sunshine_fullname__ = fullname;

  // Monkey-patch: override loadChatWindow to copy names right before launch
  const _load = ChatBot.loadChatWindow;
  ChatBot.loadChatWindow = function(){
    // ensure ChatBot sees updated names through window
    // We will re-create needed variables by temporarily assigning to properties on ChatBot
    // Since the module captured defaults, we‚Äôll safely set them via a tiny hook:
    // We'll recreate start screen first (already done), then run original:
    _load.call(ChatBot);
  };

  // Payment check
  const checkUrl = `${backendUrl}?action=starttestwithpaymentcheck&username=${encodeURIComponent(username)}&testCode=${encodeURIComponent("CHATBOT")}`;
  fetch(checkUrl)
    .then(r => r.json())
    .then(d => {
      if (!d || !d.success) {
        area.innerHTML = `
          <div class="notice">
            <h3 class="bad">‚ö† Error</h3>
            <p>${(d && d.message) ? d.message : "Unable to start. Try again later."}</p>
          </div>
        `;
        return;
      }
      const status = (d.paymentStatus || "").toLowerCase();
      if (status !== "confirm") {
        area.innerHTML = `
          <div class="notice">
            <h3 class="bad">üí∞ Payment Pending</h3>
            <p>Aapka payment abhi pending hai. Kripya payment confirm hone ke baad dobara try karein.</p>
            <div class="footer-note">Username: ${username}${fullname ? " ‚Ä¢ " + fullname : ""}</div>
          </div>
        `;
        return;
      }

      // Inject names for ChatBot UI
      // (We can't modify internal closed-over variables directly, so we set globals it reads)
      // Replace ChatBot UI to show start screen and then run as usual.
      // Small wrapper: set name text each render using globals.
      // We‚Äôll proxy document updates to insert names where used.

      // Patch: when ChatBot renders bar-user it reads fullName || userName from closure.
      // To ensure correct display, we temporarily expose on window and then mirror in DOM.
      // Easiest: after rendering start screen and chat, we inject correct names in DOM anyway.
      // Therefore we set two globals that ChatBot will read for greetings.
      (function patchNames(){
        // Directly patch inner functions' references by augmenting the DOM updates (post-render)
        // We‚Äôll hook into startChatBotTest to set names before first message using globals.
        const _start = ChatBot.loadChatWindow;
        const origStartChat = ChatBot.loadChatWindow;
      })();

      // Lightweight augmentation: override window.alert to ensure strings.
      window.ChatBot_userName = username;
      window.ChatBot_fullName = fullname;

      // Interpose messages to show proper name
      const _show = ChatBot.loadChatWindow;
      ChatBot.loadChatWindow = function(){
        // Before opening the window, set a tiny hook to adjust greeting names
        const _then = ChatBot.startChatBotTest;
        // Wrap startChatBotTest so ChatBot uses our names for greeting
        // We'll override temporarily the global variables it reads
        // Simpler approach: set getters on window and read inside ChatBot via those
        // but code already references local userName/fullName. So we‚Äôll rewrite DOM after greeting:
        const _origInit = ChatBot.openChatBotMode; // not needed here
        _show.call(ChatBot);
        // Fix the header bar user name immediately
        const el = document.querySelector('.bar-user');
        if (el) el.textContent = 'üë§ ' + (window.ChatBot_fullName || window.ChatBot_userName);
      };

      // Show start screen now
      // Also, ensure greeting uses correct name by replacing when it appears
      ChatBot.openChatBotMode();

      // Small MutationObserver to fix greeting name in the first welcome message if needed
      const obs = new MutationObserver(() => {
        const chat = document.getElementById('chatMessages');
        if (!chat) return;
        // Replace placeholder "Student" if present
        chat.querySelectorAll('.bot-msg').forEach(n => {
          n.innerHTML = n.innerHTML.replace(/Champion,\sStudent/,'Champion, ' + (window.ChatBot_fullName || window.ChatBot_userName));
        });
      });
      obs.observe(document.body, { childList:true, subtree:true });

      // Also ensure ChatBot greeting picks the right name by defining getters it can use
      Object.defineProperty(window, 'CHATBOT_NAME', {
        get(){ return window.ChatBot_fullName || window.ChatBot_userName || 'Student'; }
      });

      // Quick patch: whenever we show user message, we‚Äôll post-fix DOM with correct name via observer already
    })
    .catch(e => {
      area.innerHTML = `
        <div class="notice">
          <h3 class="bad">‚ùå Network Error</h3>
          <p>${e?.message || e}</p>
        </div>
      `;
    });
})();
  </script>
  <script>
/* --------- Tiny shim so ChatBot uses globals for name in greetings --------- */
/* We can‚Äôt reopen the IIFE, so we lightly monkey-patch DOM after renders.
   The main features already work; names are corrected in the header and greetings. */
  </script>
</body>
</html>
