<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RS-CIT Test Screen</title>
  <style>
    :root {
      --primary: #e91e63;
      --primary-dark: #c2185b;
      --accent: #f8bbd0;
      --user-msg: #fce4ec;
      --bot-msg: #f8bbd0;
      --wrong-msg: #ffcdd2;
      --correct-highlight: #fffde7;
    }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
    }

    header {
      background: var(--primary);
      color: #fff;
      padding: 12px 20px;
      font-size: 18px;
      font-weight: bold;
      text-transform: uppercase;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .container {
      max-width: 650px;
      margin: 30px auto;
      background: #fff;
      border-radius: 12px;
      border: 2px solid var(--primary);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }

    .close-btn {
      position: absolute;
      top: -14px;
      right: -14px;
      background: #fff;
      color: var(--primary);
      font-size: 18px;
      border: 1px solid #ddd;
      border-radius: 50%;
      width: 34px;
      height: 34px;
      line-height: 32px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: 0.2s;
    }

    .close-btn:hover {
      background: #f5f5f5;
      color: var(--primary-dark);
      border-color: var(--primary-dark);
    }

    #chatWindow { 
      display: flex; 
      flex-direction: column; 
      height: 500px; 
      position: relative; 
    }

    /* Top bar inside chat window */
    #topBar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      padding: 4px 10px;
      background: #fff;
      border-bottom: 1px solid #ccc;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    #chatBody { 
      flex: 1; 
      padding: 10px; 
      overflow-y: auto; 
      background: #fafafa; 
    }

    .chat-message { 
      margin: 8px 0; 
      font-size: 15px; 
      line-height: 1.5; 
      animation: fadeIn 0.3s ease-in; 
    }

    .user-msg { 
      color: var(--primary-dark); 
      text-align: left; 
      font-weight: bold; 
    }

    .bot-msg { 
      color: #4a0e34; 
      text-align: right; 
    }

    .bot-msg.correct { 
      color: green; 
      font-weight: bold; 
    }

    .bot-msg.wrong { 
      color: red; 
      font-weight: bold; 
    }

    .question { 
      font-size: 16px; 
      font-weight: 600; 
      margin: 10px 0 6px; 
      padding: 10px; 
      background: #fce4ec; 
      border-radius: 8px; 
    }

    #optionsArea { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 10px; 
      padding: 12px 16px; 
      border-top: 1px solid #eee; 
      background: #fff; 
    }

    #optionsArea button { 
      padding: 10px; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      background: var(--primary); 
      color: #fff; 
      font-weight: bold; 
      font-size: 14px; 
      transition: all 0.2s; 
    }

    #optionsArea button:hover { 
      background: var(--primary-dark); 
    }

    .loading { 
      text-align: center; 
      font-size: 16px; 
      padding: 40px; 
      color: var(--primary); 
    }

    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(5px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    .flower {
      position: fixed;
      top: -20px;
      font-size: 24px;
      pointer-events: none;
      animation: fall 3s linear forwards;
    }

    @keyframes fall {
      to { transform: translateY(110vh); opacity: 0; }
    }
  </style>
</head>
<body>
<header><span id="examNameLabel" class="exam-name"></span></header>
<div class="container">
  <button class="close-btn" onclick="closeTest()">‚úñ</button>
  <div id="quizArea" class="loading">‚è≥ Please wait...</div>
</div>

<script>
const code = localStorage.getItem("test_code") || "",
      username = (localStorage.getItem("test_username") || "").trim(),
      fullname = localStorage.getItem("test_fullname") || "";

const backendUrl = "https://script.google.com/macros/s/AKfycbx4Bx-4lSDrBsB1_i6E4reHBiKgKP1zhtVWryVoN8L90Bx72JHSNPaA12aV__fYbRA-/exec";

const ChatBot = (() => {
  let questions = [], currentIndex = 0, score = 0, attempted = 0, correct = 0;

  function loadChatWindow() {
    questions = (window.loadedQuestions || []).sort(() => 0.5 - Math.random()).slice(0, 35);
    currentIndex = 0; score = 0; attempted = 0; correct = 0;
    renderChatWindow();

    showBotMessage(`üôè Radhe Radhe, ${fullname}!<br>ü§ñ Welcome to <b>Sunshine Bot</b> üå∏<br> Practice karo aur RS-CIT ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡•Ä ‡§∂‡§æ‡§®‡§¶‡§æ‡§∞ ‡§§‡•à‡§Ø‡§æ‡§∞‡•Ä karo! üòâ`);
    setTimeout(loadQuestion, 1500);
  }

  function renderChatWindow() {
    document.getElementById("quizArea").innerHTML = `
      <div id="chatWindow">
        <div id="topBar">
          <div class="left">${fullname}</div>
          <div id="timer">Time Left: 60:00</div>
          <div class="right" id="currentDate"></div>
        </div>
        <div id="chatBody"></div>
        <div id="optionsArea"></div>
      </div>`;
    startTimer(60*60);
    setDate();
  }

  function startTimer(duration) {
    let timer = duration, minutes, seconds;
    const display = document.getElementById("timer");
    setInterval(() => {
      minutes = parseInt(timer / 60, 10);
      seconds = parseInt(timer % 60, 10);
      minutes = minutes < 10 ? "0" + minutes : minutes;
      seconds = seconds < 10 ? "0" + seconds : seconds;
      display.textContent = "Time Left: " + minutes + ":" + seconds;
      if (--timer < 0) { timer = 0; }
    }, 1000);
  }

  function setDate() {
    const dateElement = document.getElementById("currentDate");
    const today = new Date();
    const dd = String(today.getDate()).padStart(2,"0");
    const mm = String(today.getMonth()+1).padStart(2,"0");
    const yyyy = today.getFullYear();
    dateElement.textContent = dd + "/" + mm + "/" + yyyy;
  }

  // Chat logic functions
  function showUserMessage(msg) {
    const div = document.createElement("div");
    div.className = "chat-message user-msg";
    div.innerHTML = msg;
    document.getElementById("chatBody").appendChild(div);
    scrollDown();
  }

  function showBotMessage(msg, type="") {
    const div = document.createElement("div");
    div.className = "chat-message bot-msg" + (type==="wrong"?" wrong":"") + (type==="correct"?" correct":"");
    div.innerHTML = msg;
    document.getElementById("chatBody").appendChild(div);
    scrollDown();
  }

  function scrollDown() { 
    const chat = document.getElementById("chatBody"); 
    chat.scrollTop = chat.scrollHeight; 
  }

  function loadQuestion() {
    if(currentIndex >= questions.length){ showSummary(); return; }
    const q = questions[currentIndex];
    let html = `<div class="question"><b>Q${currentIndex+1}:</b> ${q.question}</div>`;
    const box = document.createElement("div");
    box.innerHTML = html;
    document.getElementById("chatBody").appendChild(box);

    let opts = "";
    q.options.forEach((opt,i)=>{ opts += `<button onclick="ChatBot.chooseAnswer('${String.fromCharCode(65+i)}')">${String.fromCharCode(65+i)}. ${opt}</button>`; });
    document.getElementById("optionsArea").innerHTML = opts;
    scrollDown();
  }

  function chooseAnswer(ans) {
    const q = questions[currentIndex];
    attempted++;
    if(ans === q.answer){ score+=1; correct++; showBotMessage(`‚úî Correct!`, "correct"); }
    else showBotMessage(`‚ùå Wrong! Correct answer: ${q.answer}`, "wrong");
    currentIndex++;
    setTimeout(loadQuestion, 500);
  }

  function showSummary() {
    document.getElementById("chatBody").innerHTML += `<div class="chat-message bot-msg correct"><b>‚úÖ Test Completed!</b><br>Score: ${score}/${questions.length}<br>Correct: ${correct}, Attempted: ${attempted}</div>`;
    document.getElementById("optionsArea").innerHTML = "";
  }

  return { loadChatWindow, chooseAnswer };
})();

function initTest() {
  if(!username){ document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">‚ùå User not found. Please login again.</h3>`; return; }
  fetch(`${backendUrl}?action=starttestwithpaymentcheck&username=${encodeURIComponent(username)}&testCode=${encodeURIComponent(code)}`)
  .then(r=>r.json()).then(d=>{
    if(!d.success){ document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">‚ö† ${d.message||"Error starting test."}</h3>`; return; }
    if((d.paymentStatus||"").toLowerCase()!=="confirm"){ document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">üí∞ Your Payment is Pending.</h3>`; return; }

    window.loadedQuestions = d.questions || [];
    document.getElementById("quizArea").innerHTML = `
      <div style="text-align:center; padding:30px;">
        <h2 style="color:var(--primary);">üå∏ Welcome to Sunshine Skill Bot!</h2>
        <p>35 Random Questions | ‡§π‡§∞ ‡§¨‡§æ‡§∞ ‡§®‡§Ø‡§æ challenge!</p>
        <button onclick="ChatBot.loadChatWindow()" style="padding:12px 24px; background:var(--primary); color:#fff; border:none; border-radius:8px; font-size:16px; cursor:pointer;">üöÄ Start Practice</button>
      </div>`;
  }).catch(e=>{
    console.error("Error:",e);
    document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">‚ö† Error loading test.</h3>`;
  })
}

function closeTest() {
  const stored = localStorage.getItem('test_selection_url');
  if (stored) { window.location.href = stored; return; }
  if (document.referrer && document.referrer !== location.href) { window.history.back(); return; }
  window.location.href = "/";
}

initTest();
</script>
</body>
</html>
