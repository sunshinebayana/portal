<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>RS-CIT Test Screen</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fff; /* ‡§¨‡§æ‡§π‡§∞ ‡§ï‡§æ area white */
      margin: 0;
      padding: 0;
    }
    header {
      background: #e91e63;
      color: #fff;
      padding: 10px 20px;
      font-size: 18px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .exam-name {
      font-size: 20px;
      font-weight: bold;
      text-transform: uppercase;
    }
    .container {
      max-width: 420px; /* width ‡§ï‡§Æ ‡§ï‡•Ä */
      margin: 30px auto;
      background: #fff;
      padding: 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,.1);
      position: relative;
    }
    .close-btn {
      position: absolute;
      top: -14px;
      right: -14px;
      background: #fff;
      color: #e91e63;
      font-size: 18px;
      border: 1px solid #ccc;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      line-height: 28px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,.15);
      transition: .2s;
    }
    .close-btn:hover {
      background: #f5f5f5;
      color: #c2185b;
      border-color: #c2185b;
    }
    .chat-message {
      margin: 6px 0;
      padding: 10px;
      border-radius: 6px;
      max-width: 85%;
      line-height: 1.4;
    }
    .user-msg {
      background: #fce4ec;
      color: #d81b60;
      text-align: right;
      margin-left: auto;
    }
    .bot-msg {
      background: #f8bbd0;
      color: #880e4f;
      text-align: left;
      margin-right: auto;
    }
    .bot-msg.wrong {
      background: #ffcdd2;
      color: #b71c1c;
    }
    .question {
      font-size: 16px;
      font-weight: bold;
      margin: 0; /* space ‡§π‡§ü‡§æ ‡§¶‡•Ä */
      text-align: left;
    }
    .loading {
      text-align: center;
      font-size: 16px;
      padding: 20px;
      color: #e91e63;
    }

    /* Chat Window */
    #chatWindow {
      background: #fff;
      border-radius: 10px;
      padding: 0;
      box-shadow: 0 2px 10px rgba(0,0,0,.1);
      height: 500px;
      display: flex;
      flex-direction: column;
    }
    #chatBody {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }

    /* Options fixed at bottom */
    #optionsArea {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      padding: 10px 16px;
      border-top: 1px solid #ddd;
      background: #fff;
    }
    #optionsArea button {
      padding: 10px;
      border: 1px solid #e91e63;
      border-radius: 6px;
      cursor: pointer;
      background: #fff0f6;
      color: #e91e63;
      font-weight: bold;
      transition: .2s;
    }
    #optionsArea button:hover {
      background: #e91e63;
      color: #fff;
    }
  </style>
</head>
<body>
<header><span id="examNameLabel" class="exam-name"></span></header>
<div class="container">
  <button class="close-btn" onclick="closeTest()">‚úñ</button>
  <div id="quizArea" class="loading">‚è≥ Please wait...</div>
</div>

<script>
const code=localStorage.getItem("test_code")||"",
      username=(localStorage.getItem("test_username")||"").trim(),
      fullname=localStorage.getItem("test_fullname")||"";

const backendUrl="https://script.google.com/macros/s/AKfycbx4Bx-4lSDrBsB1_i6E4reHBiKgKP1zhtVWryVoN8L90Bx72JHSNPaA12aV__fYbRA-/exec";

/* ---------------- ChatBot ---------------- */
const ChatBot = (() => {
  let questions = [];
  let currentIndex = 0;
  let score = 0;
  let attempted = 0;
  let correct = 0;

  function loadChatWindow() {
    questions = (window.loadedQuestions || []).sort(() => 0.5 - Math.random()).slice(0, 35);
    currentIndex = 0;
    score = 0;
    attempted = 0;
    correct = 0;

    renderChatWindow();

    // Welcome message ‡§≠‡•Ä scroll ‡§π‡•ã‡§ó‡§æ
    showBotMessage(`üôè ‡§∞‡§æ‡§ß‡•á ‡§∞‡§æ‡§ß‡•á, ${fullname}!<br>ü§ñ Hey Champion üëã<br>
    Sunshine Bot ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à üå∏<br>
    Practice ‡§ï‡§∞‡•ã, marks ‡§ï‡§Æ‡§æ‡§ì ‡§î‡§∞ RS-CIT ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡•Ä ‡§Æ‡§ú‡•á‡§¶‡§æ‡§∞ ‡§§‡•à‡§Ø‡§æ‡§∞‡•Ä ‡§ï‡§∞‡•ã! üòâ`);

    setTimeout(loadQuestion,1500);
  }

  function renderChatWindow() {
    document.getElementById("quizArea").innerHTML = `
      <div id="chatWindow">
        <div id="chatBody"></div>
        <div id="optionsArea"></div>
      </div>
    `;
  }

  function showUserMessage(msg) {
    const div = document.createElement("div");
    div.className="chat-message user-msg";
    div.innerHTML=msg;
    document.getElementById("chatBody").appendChild(div);
    scrollDown();
  }

  function showBotMessage(msg,type="correct") {
    const div = document.createElement("div");
    div.className="chat-message bot-msg" + (type==="wrong"?" wrong":"");
    div.innerHTML=msg;
    document.getElementById("chatBody").appendChild(div);
    scrollDown();
  }

  function showCorrectAnswer(msg){
    const div=document.createElement("div");
    div.className="chat-message bot-msg";
    div.style.background="#fffde7";
    div.style.color="#f57f17";
    div.innerHTML=msg;
    document.getElementById("chatBody").appendChild(div);
    scrollDown();
  }

  function scrollDown(){
    const chat=document.getElementById("chatBody");
    chat.scrollTop=chat.scrollHeight;
  }

  function loadQuestion() {
    if (currentIndex >= questions.length) {
      showSummary();
      return;
    }

    const q = questions[currentIndex];
    let html = `<div class="question"><b>Q${currentIndex+1}:</b> ${q.question}</div>`;
    const box=document.createElement("div");
    box.innerHTML=html;
    document.getElementById("chatBody").appendChild(box);

    // Options render ‡§ï‡§∞‡•á‡§Ç bottom ‡§™‡§∞
    let opts = "";
    q.options.forEach((opt, i) => {
      opts += `<button onclick="ChatBot.chooseAnswer('${String.fromCharCode(65+i)}')">${String.fromCharCode(65+i)}. ${opt}</button>`;
    });
    document.getElementById("optionsArea").innerHTML = opts;

    scrollDown();
  }

  function chooseAnswer(option){
    const q = questions[currentIndex];
    const correctOption = (q.answer||"").trim().toUpperCase();
    const correctText = q.options[correctOption.charCodeAt(0)-65] || "";
    const selectedText = q.options[option.charCodeAt(0)-65] || "";

    attempted++;
    showUserMessage(`üë§ ${fullname}: ${option}. ${selectedText}`);

    if(option===correctOption){
      score+=2;
      correct++;
      showBotMessage(`ü§ñ Wah, ${fullname}! üëÜ ‡§∏‡§π‡•Ä ‡§ú‡§µ‡§æ‡§¨! (+2 Marks) | Total: ${score}`,"correct");
      checkMilestones();
    } else {
      showBotMessage(`ü§ñ Oops, ${fullname}! üëÜ ‡§ó‡§≤‡§§ ‡§ú‡§µ‡§æ‡§¨. | Total: ${score}`,"wrong");
      showCorrectAnswer(`ü§ñ ‡§∏‡§π‡•Ä ‡§ú‡§µ‡§æ‡§¨ ‡§π‡•àüëâ: ${correctOption}. ${correctText}`);
    }

    currentIndex++;
    document.getElementById("optionsArea").innerHTML = "";

    // ‡§Ö‡§ó‡§≤‡§æ question 2s delay ‡§∏‡•á ‡§Ü‡§è‡§ó‡§æ
    setTimeout(loadQuestion,2000);
  }

  function checkMilestones(){
    if(score===28){
      showBotMessage(`üéâ Celebration Time, ${fullname}! You hit 28 Marks!`);
    } else if(score===42){
      showBotMessage(`üöÄ ${fullname}, First Division ‡§π‡§æ‡§∏‡§ø‡§≤! Keep going!`);
    } else if(score===50){
      showBotMessage(`üî• Excellent! 25 Questions Correct! Next Goal ‚Äì 30! üåü`);
    } else if(score===60){
      showBotMessage(`üåü Outstanding! 30 Correct ‚Äì Almost Topper! üöÄ`);
    } else if(score===70){
      showBotMessage(`üéä Incredible! Perfect 35/35 ‚Äì Record Tod Diya! üèÜ`);
    }
  }

  function showSummary(){
    showBotMessage(`ü§ñ Practice Complete, ${fullname}!`);
    showBotMessage(`‚úî Attempted: ${attempted}<br>‚úî Correct: ${correct}<br>‚úî Marks: ${score}`);
    document.getElementById("optionsArea").innerHTML="";
  }

  return { loadChatWindow, chooseAnswer };
})();

/* ---------------- Backend Init ---------------- */
function initTest(){
  if(!username){
    document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">‚ùå User not found. Please login again.</h3>`;
    return;
  }
  fetch(`${backendUrl}?action=starttestwithpaymentcheck&username=${encodeURIComponent(username)}&testCode=${encodeURIComponent(code)}`)
  .then(r=>r.json()).then(d=>{
    if(!d.success){
      document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">‚ö† ${d.message||"Error starting test."}</h3>`;
      return;
    }
    if((d.paymentStatus||"").toLowerCase()!=="confirm"){
      document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">üí∞ Your Payment is Pending.</h3>`;
      return;
    }

    window.loadedQuestions = d.questions || [];

    document.getElementById("quizArea").innerHTML = `
      <div style="text-align:center; padding:20px;">
        <h2 style="color:#e91e63;">üå∏ Welcome to Sunshine Skill Bot!</h2>
        <p>35 Random Questions | ‡§π‡§∞ ‡§¨‡§æ‡§∞ ‡§®‡§Ø‡§æ challenge!</p>
        <p>‡§Ö‡§¨ ‡§π‡•ã‡§ó‡•Ä RS-CIT ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡•Ä ‡§∂‡§æ‡§®‡§¶‡§æ‡§∞ ‡§§‡•à‡§Ø‡§æ‡§∞‡•Ä!</p>
        <button onclick="ChatBot.loadChatWindow()" style="padding:10px 20px; background:#e91e63; color:#fff; border:none; border-radius:6px; font-size:16px; cursor:pointer;">üöÄ Start Practice</button>
      </div>
    `;
  }).catch(e=>{
    console.error("Error:",e);
    document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">‚ö† Error loading test.</h3>`;
  })
}

/* ---------------- Close Test ---------------- */
function closeTest(){
  const stored = localStorage.getItem('test_selection_url');
  if (stored) { window.location.href = stored; return; }
  if (document.referrer && document.referrer !== location.href) {
    window.history.back();
    return;
  }
  window.location.href = "/";
}

initTest();
</script>
</body>
</html>
