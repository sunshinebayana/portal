<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>RS-CIT Test Screen</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f9f9f9;margin:0;padding:0}
    header{background:#1976d2;color:#fff;padding:10px 20px;font-size:18px;display:flex;flex-direction:column;gap:5px}
    .exam-name{font-size:20px;font-weight:bold;text-transform:uppercase}
    .container{max-width:700px;margin:30px auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);position:relative}
    .close-btn{position:absolute;top:-14px;right:-14px;background:#fff;color:#1976d2;font-size:18px;border:1px solid #ccc;border-radius:50%;width:30px;height:30px;line-height:28px;text-align:center;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.15);transition:.2s}
    .close-btn:hover{background:#f5f5f5;color:#d32f2f;border-color:#d32f2f}
    .top-info-row,.quiz-indicator-row{display:flex;justify-content:space-between;align-items:center;font-size:14px;color:#555;margin:10px 0;font-weight:bold}
    #timerDisplay{font-weight:bold;background:rgba(255,255,255,.8);padding:5px 10px;border-radius:4px;color:#1976d2;font-size:16px}
    .question{font-size:16px;font-weight:bold;margin-bottom:10px;text-align:left}
    .options button{display:block;width:100%;margin:6px 0;padding:8px;border:1px solid #1976d2;border-radius:6px;cursor:pointer;background:#f9f9f9;color:#1976d2;font-weight:bold;transition:.2s}
    .options button:hover{background:#1976d2;color:#fff}
    .message{text-align:center;color:red;margin-top:10px;font-weight:bold}
    .loading{text-align:center;font-size:16px;padding:20px;color:#1976d2}
  </style>
</head>
<body>
<header><span id="examNameLabel" class="exam-name"></span></header>
<div class="container">
  <button class="close-btn" onclick="closeTest()">‚úñ</button>
  <div id="quizArea" class="loading">‚è≥ Please wait...</div>
</div>

<script>
const code=localStorage.getItem("test_code")||"",
      mode=(localStorage.getItem("test_mode")||"").toLowerCase(),
      username=(localStorage.getItem("test_username")||"").trim(),
      fullname=localStorage.getItem("test_fullname")||"";

const backendUrl="https://script.google.com/macros/s/AKfycbx4Bx-4lSDrBsB1_i6E4reHBiKgKP1zhtVWryVoN8L90Bx72JHSNPaA12aV__fYbRA-/exec";

/* ---------------- ChatBot ---------------- */
const ChatBot = (() => {
  let questions = [];
  let currentIndex = 0;
  let score = 0;

  function loadChatWindow() {
    // 35 Random Questions
    questions = (window.loadedQuestions || []).sort(() => 0.5 - Math.random()).slice(0, 35);
    currentIndex = 0;
    score = 0;

    renderChatWindow();
    loadQuestion();
  }

  function renderChatWindow() {
    document.getElementById("quizArea").innerHTML = `
      <div id="chatWindow" style="background:#fff; border-radius:10px; padding:20px; box-shadow:0 2px 10px rgba(0,0,0,.1);">
        <div id="chatHeader" style="margin-bottom:15px; text-align:center; font-size:15px; font-weight:bold; color:#1976d2;">
          üôè‡§∞‡§æ‡§ß‡•á ‡§∞‡§æ‡§ß‡•áüôè, ‡§¶‡•ã‡§∏‡•ç‡§§‡•ã‡§Ç<br>
          ü§ñ Hey Champion, ${fullname}! üëã<br>
          Sunshine Bot me swagat hai ‚Äì<br>
          Practice karo, marks jeeto aur 3 August 2025 ko hone wali RS-CIT pariksha ki mazedar tarike se taiyari karo!<br>
          Apni skills ko next level par le jao! üòâ
        </div>
        <div id="chatBody"></div>
      </div>
    `;
  }

  function loadQuestion() {
    if (currentIndex >= questions.length) {
      document.getElementById("chatBody").innerHTML = `
        <h3>‚úÖ Practice Complete!</h3>
        <p>Total Score: ${score}/${questions.length}</p>
      `;
      return;
    }

    const q = questions[currentIndex];
    let html = `<div class="question"><b>Q${currentIndex+1}:</b> ${q.question}</div>`;
    html += `<div class="options">`;
    q.options.forEach((opt, i) => {
      html += `<button onclick="ChatBot.checkAnswer(${i})">${opt}</button>`;
    });
    html += `</div><div id="feedback" style="margin-top:10px; font-weight:bold;"></div>`;

    document.getElementById("chatBody").innerHTML = html;
  }

  function checkAnswer(selected) {
    const correct = (questions[currentIndex].answer || "").trim().toUpperCase();
    const chosen = String.fromCharCode(65 + selected);

    if (chosen === correct) {
      score++;
      document.getElementById("feedback").innerHTML = `<span style="color:green;">‚úÖ Bilkul sahi jawab!</span>`;
    } else {
      document.getElementById("feedback").innerHTML = `<span style="color:red;">‚ùå Galat! Sahi jawab: ${correct}</span>`;
    }

    setTimeout(() => {
      currentIndex++;
      loadQuestion();
    }, 1200);
  }

  return { loadChatWindow, checkAnswer };
})();

/* ---------------- Backend Init ---------------- */
function initTest(){
  if(!username){
    document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">‚ùå User not found. Please login again.</h3>`;
    return;
  }
  fetch(`${backendUrl}?action=starttestwithpaymentcheck&username=${encodeURIComponent(username)}&testCode=${encodeURIComponent(code)}`)
  .then(r=>r.json()).then(d=>{
    if(!d.success){
      document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">‚ö† ${d.message||"Error starting test."}</h3>`;
      return;
    }
    if((d.paymentStatus||"").toLowerCase()!=="confirm"){
      document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">üí∞ Your Payment is Pending.</h3>`;
      return;
    }

    // ‚úÖ Store questions for chatbot
    window.loadedQuestions = d.questions || [];

    // ‚úÖ Show Sunshine Bot Welcome Screen
    document.getElementById("quizArea").innerHTML = `
      <div style="text-align:center; padding:20px;">
        <h2>üåû Welcome to Sunshine Skill Bot!</h2>
        <p>35 Random Questions | Har Baar Naya Challenge!</p>
        <p>‡§Ö‡§¨ ‡§π‡•ã‡§ó‡•Ä ‡§Ü‡§®‡•á ‡§µ‡§æ‡§≤‡•á RS-CIT ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡•Ä ‡§∂‡§æ‡§®‡§¶‡§æ‡§∞ ‡§§‡•à‡§Ø‡§æ‡§∞‡•Ä!</p>
        <button onclick="ChatBot.loadChatWindow()" style="padding:10px 20px; background:#1976d2; color:#fff; border:none; border-radius:6px; font-size:16px; cursor:pointer;">üöÄ Start Practice</button>
      </div>
    `;
  }).catch(e=>{
    console.error("Error:",e);
    document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">‚ö† Error loading test.</h3>`;
  })
}

/* ---------------- Close Test ---------------- */
function closeTest(){
  const stored = localStorage.getItem('test_selection_url');
  if (stored) { window.location.href = stored; return; }
  if (document.referrer && document.referrer !== location.href) {
    window.history.back();
    return;
  }
  window.location.href = "/";
}

initTest();
</script>
</body>
</html>
