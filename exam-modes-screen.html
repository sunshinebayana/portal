<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>RS-CIT Test Screen</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f9f9f9;margin:0;padding:0}
    header{background:#1976d2;color:#fff;padding:10px 20px;font-size:18px;display:flex;flex-direction:column;gap:5px}
    .exam-name{font-size:20px;font-weight:bold;text-transform:uppercase}
    .container{max-width:700px;margin:30px auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);position:relative}
    .close-btn{position:absolute;top:-14px;right:-14px;background:#fff;color:#1976d2;font-size:18px;border:1px solid #ccc;border-radius:50%;width:30px;height:30px;line-height:28px;text-align:center;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.15);transition:.2s}
    .close-btn:hover{background:#f5f5f5;color:#d32f2f;border-color:#d32f2f}
    .top-info-row,.quiz-indicator-row{display:flex;justify-content:space-between;align-items:center;font-size:14px;color:#555;margin:10px 0;font-weight:bold}
    #timerDisplay{font-weight:bold;background:rgba(255,255,255,.8);padding:5px 10px;border-radius:4px;color:#1976d2;font-size:16px}
    .question{font-size:16px;font-weight:bold;margin-bottom:10px;text-align:left}
    .options label{display:block;background:#f1f1f1;padding:8px;margin:6px 0;border-radius:4px;cursor:pointer;text-align:left}
    .button-row{display:flex;justify-content:space-between;margin-top:10px}
    button{padding:8px 16px;border:none;border-radius:4px;background:#1976d2;color:#fff;font-size:14px;cursor:pointer}
    button:hover{background:#125aa0}
    .message{text-align:center;color:red;margin-top:10px;font-weight:bold}
    .loading{text-align:center;font-size:16px;padding:20px;color:#1976d2}
    .question-nav{display:flex;flex-wrap:wrap;gap:5px;margin-top:15px;justify-content:center}
    .question-btn{width:32px;height:32px;border:1px solid #1976d2;background:#f1f1f1;color:#1976d2;text-align:center;line-height:30px;border-radius:4px;cursor:pointer;font-weight:bold;transition:.2s}
    .question-btn:hover{background:#e0e0e0}
    .question-btn.attempted{background:#4caf50;color:#fff;border-color:#4caf50}
    .confirm-box{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000}
    .confirm-content{background:#fff;padding:20px;border-radius:8px;text-align:center;width:300px;box-shadow:0 2px 10px rgba(0,0,0,.3)}
    .confirm-content p{margin-bottom:15px;font-size:16px;font-weight:bold}
    .confirm-buttons{display:flex;justify-content:space-around}
    .confirm-buttons button{flex:1;margin:0 5px}

    /* ‚úÖ Scoreboard Styling */
    .scoreboard{max-width:600px;margin:10px auto;background:#fff;padding:25px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.15);text-align:left;animation:fadeIn .5s ease}
    .scoreboard h2{text-align:center;margin-bottom:20px;color:#1976d2}
    .score-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee}
    .score-item:last-child{border-bottom:none}
    .score-label{font-weight:bold;color:#444}
    .score-value{color:#1976d2}
    .score-result.pass{color:#4caf50;font-weight:bold}
    .score-result.fail{color:#d32f2f;font-weight:bold}
    .score-close{text-align:center;margin-top:20px}
    .score-close button{background:#d32f2f}
    .score-close button:hover{background:#b71c1c}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>
<header><span id="examNameLabel" class="exam-name"></span></header>
<div class="container">
  <button class="close-btn" onclick="closeTest()">‚úñ</button>
  <div class="top-info-row">
    <div id="fullnameLabel"></div>
    <div id="timerDisplay">‚è≥ Time Left: --:--</div>
    <div><strong>Exam Time:</strong> <span id="examTimeInTest"></span> mins</div>
  </div>
  <div class="quiz-indicator-row">
    <div id="quizIndicator"></div><div id="examNameInTest"></div><div id="modeLabel"></div>
  </div>
  <div id="quizArea" class="loading">‚è≥ Please wait...</div>
  <div id="questionNav" class="question-nav"></div>
</div>

<!-- Confirm box -->
<div id="confirmBox" class="confirm-box" style="display:none;">
  <div class="confirm-content">
    <p>Are you sure you want to submit this test?</p>
    <div class="confirm-buttons">
      <button onclick="confirmSubmit()">OK</button>
      <button onclick="cancelSubmit()">Cancel</button>
    </div>
  </div>
</div>

<script>
const code=localStorage.getItem("test_code")||"",
      mode=(localStorage.getItem("test_mode")||"").toLowerCase(),
      username=(localStorage.getItem("test_username")||"").trim(),
      fullname=localStorage.getItem("test_fullname")||"";

document.getElementById("modeLabel").textContent=mode?`Mode: ${mode[0].toUpperCase()+mode.slice(1)}`:"";
document.getElementById("fullnameLabel").textContent=fullname?`üë§ ${fullname}`:"üë§ Guest User";

let questions=[],currentQ=0,score=0,testDuration=0,maxMarks=0,timerInterval,attempted=[];
let startTime=Date.now();

function updateQuizIndicator(){
  document.getElementById("quizIndicator").textContent=`Question ${currentQ+1} of ${questions.length}`;
  renderQuestionNav();
}
function renderQuestionNav(){
  const nav=document.getElementById("questionNav");
  nav.innerHTML="";
  questions.forEach((q,i)=>{
    const btn=document.createElement("div");
    btn.textContent=i+1;
    btn.className="question-btn";
    if(attempted[i]) btn.classList.add("attempted");
    btn.onclick=()=>{currentQ=i;mode==="exam"?loadQuestionExamMode():loadQuestionPracticeMode()};
    nav.appendChild(btn);
  });
}
function renderNavigationButtons(){
  return `<div class="button-row">
    <button onclick="prevQuestion()" ${currentQ===0?'disabled':''}>Previous</button>
    ${currentQ<questions.length-1?`<button onclick="${mode==='exam'?'nextQuestionExam()':'checkPracticeAnswer()'}">Save & Next</button>`:""}
    <button onclick="showConfirmBox()">Submit Test</button>
  </div>`;
}
function markAttempted(){attempted[currentQ]=true}

/* ---------------- Exam Mode ---------------- */
function loadQuestionExamMode(){
  const q=questions[currentQ];
  updateQuizIndicator();
  let html=`<div class="question">${currentQ+1}. ${q.question}</div><div class="options">`;
  q.options.forEach((opt,i)=>{
    html+=`<label><input type="radio" name="option" value="${i}" ${attempted[currentQ]&&q.selected===i?'checked':''}> ${opt}</label>`;
  });
  document.getElementById("quizArea").innerHTML=html+"</div>"+renderNavigationButtons();
}

function nextQuestionExam(){
  const ans=document.querySelector("input[name='option']:checked");
  if(!ans){alert("Please select an answer!");return}
  const idx=parseInt(ans.value);
  questions[currentQ].selected=idx;
  markAttempted();
  if(String.fromCharCode(65+idx)===(questions[currentQ].answer||"").trim().toUpperCase()) score++;
  currentQ++;
  if(currentQ<questions.length){loadQuestionExamMode()}else{showConfirmBox()}
}

function prevQuestion(){if(currentQ>0){currentQ--;mode==="exam"?loadQuestionExamMode():loadQuestionPracticeMode()}}

/* ---------------- Practice Mode ---------------- */
function loadQuestionPracticeMode(){
  const q=questions[currentQ];
  updateQuizIndicator();
  let html=`<div class="question">${currentQ+1}. ${q.question}</div><div class="options">`;
  q.options.forEach((opt,i)=>{html+=`<label><input type="radio" name="option" value="${i}"> ${opt}</label>`});
  document.getElementById("quizArea").innerHTML=html+"</div>"+renderNavigationButtons()+`<div class="message" id="practiceMsg"></div>`;
}

function checkPracticeAnswer(){
  const ans=document.querySelector("input[name='option']:checked");
  if(!ans){alert("Please select an answer!");return}
  markAttempted();
  const selected=String.fromCharCode(65+parseInt(ans.value)),
        correct=(questions[currentQ].answer||"").trim().toUpperCase();
  if(selected===correct){
    score++;
    currentQ<questions.length-1?loadQuestionPracticeMode(++currentQ):submitExam()
  }else{
    document.getElementById("practiceMsg").textContent="‚ùå Galat Answer! Dubara try karein.";
  }
}

/* ---------------- Submit ---------------- */
function showConfirmBox(){document.getElementById("confirmBox").style.display="flex"}
function confirmSubmit(){document.getElementById("confirmBox").style.display="none";submitExam()}
function cancelSubmit(){document.getElementById("confirmBox").style.display="none"}

function submitExam(){
  clearInterval(timerInterval);
  const totalQ=questions.length;
  const attemptedQ=attempted.filter(Boolean).length;
  const correctAns=score;
  const maxMarksCalc=maxMarks||totalQ;
  const obtained=correctAns;
  const percentage=maxMarksCalc>0? (obtained/maxMarksCalc)*100 : 0;
  let result="N/A";
  if(maxMarksCalc>0){ result=percentage>=40?"Pass":"Fail"; }

  const endTime=Date.now();
  const timeTakenMs=endTime-startTime;
  const mins=Math.floor(timeTakenMs/60000);
  const secs=Math.floor((timeTakenMs%60000)/1000);

  // ‚úÖ Current Date dd-mm-yyyy
  const today=new Date();
  const currentDate=`${String(today.getDate()).padStart(2,'0')}-${String(today.getMonth()+1).padStart(2,'0')}-${today.getFullYear()}`;

  // ‚úÖ Scoreboard UI (Full Name & Test Time removed, margin reduced, current date added)
  document.getElementById("quizArea").innerHTML=`
    <div class="scoreboard">
      <h2>üìä Scoreboard</h2>
      <div class="score-item"><span class="score-label">Date:</span><span class="score-value">${currentDate}</span></div>
      <div class="score-item"><span class="score-label">Result:</span><span class="score-result ${String(result).toLowerCase()}">${result}</span></div>
      <div class="score-item"><span class="score-label">Max Marks:</span><span class="score-value">${maxMarksCalc}</span></div>
      <div class="score-item"><span class="score-label">Obtained Marks:</span><span class="score-value">${obtained}</span></div>
      <div class="score-item"><span class="score-label">Total Questions:</span><span class="score-value">${totalQ}</span></div>
      <div class="score-item"><span class="score-label">Attempted:</span><span class="score-value">${attemptedQ}</span></div>
      <div class="score-item"><span class="score-label">Correct Answers:</span><span class="score-value">${correctAns}</span></div>
      <div class="score-item"><span class="score-label">Time Taken:</span><span class="score-value">${mins}m ${secs}s</span></div>
      <div class="score-close"><button onclick="closeTest()">Close</button></div>
    </div>
  `;
  document.getElementById("quizIndicator").textContent="";
  document.getElementById("questionNav").innerHTML="";
}

/* ---------------- Timer ---------------- */
function closeTest(){
  const stored = localStorage.getItem('test_selection_url');
  if (stored) { window.location.href = stored; return; }
  if (document.referrer && document.referrer !== location.href) {
    window.history.back();
    return;
  }
  window.location.href = "/";
}
function startTimer(mins){
  let t=mins*60;
  function update(){
    const m=Math.floor(t/60),s=t%60;
    document.getElementById("timerDisplay").textContent=`‚è≥ Time Left: ${m}:${s<10?"0":""}${s}`;
    if(--t<0){
      clearInterval(timerInterval);
      alert("‚è≥ Time is up! Submitting your test...");
      submitExam();
    }
  }
  update();
  timerInterval=setInterval(update,1000);
}

/* ---------------- Backend Init ---------------- */
const backendUrl="https://script.google.com/macros/s/AKfycbx4Bx-4lSDrBsB1_i6E4reHBiKgKP1zhtVWryVoN8L90Bx72JHSNPaA12aV__fYbRA-/exec";

function initTest(){
  if(!username){
    document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">‚ùå User not found. Please login again.</h3>`;
    return;
  }
  fetch(`${backendUrl}?action=starttestwithpaymentcheck&username=${encodeURIComponent(username)}&testCode=${encodeURIComponent(code)}`)
  .then(r=>r.json()).then(d=>{
    if(!d.success){
      document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">‚ö† ${d.message||"Error starting test."}</h3>`;
      return;
    }
    if((d.paymentStatus||"").toLowerCase()!=="confirm"){
      document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">üí∞ Your Payment is Pending.</h3>`;
      return;
    }
    document.getElementById("examNameInTest").textContent=`Exam Name: ${d.examName||""}`;
    testDuration=d.testDuration||0;document.getElementById("examTimeInTest").textContent=testDuration;
    maxMarks=d.maxMarks||0;questions=d.questions||[];attempted=new Array(questions.length).fill(false);
    if(!questions.length){
      document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">‚ö† No questions found.</h3>`;
      return;
    }
    currentQ=0;score=0;startTime=Date.now();startTimer(testDuration);
    mode==="exam"?loadQuestionExamMode():
    mode==="practice"?loadQuestionPracticeMode():
    document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">‚ö† Invalid test mode.</h3>`;
  }).catch(e=>{
    console.error("Error:",e);
    document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">‚ö† Error loading test.</h3>`;
  })
}

initTest();
</script>
</body>
</html>
