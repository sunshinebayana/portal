<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RS-CIT Test Screen</title>
<style>
body{font-family:Arial,sans-serif;background:#f9f9f9;margin:0;padding:0}
header{background:#1976d2;color:#fff;padding:10px 20px;font-size:18px;display:flex;flex-direction:column;gap:5px}
.exam-name{font-size:20px;font-weight:bold;text-transform:uppercase}
.container{max-width:700px;margin:30px auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);position:relative}
.close-btn{position:absolute;top:-14px;right:-14px;background:#fff;color:#1976d2;font-size:18px;border:1px solid #ccc;border-radius:50%;width:30px;height:30px;line-height:28px;text-align:center;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.15);transition:.2s}
.close-btn:hover{background:#f5f5f5;color:#d32f2f;border-color:#d32f2f}
.top-info-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;font-size:14px;color:#555;font-weight:bold}
#timerDisplay{font-weight:bold;background:rgba(255,255,255,.8);padding:5px 10px;border-radius:4px;color:#1976d2;font-size:16px}
.quiz-indicator-row{display:flex;justify-content:space-between;align-items:center;font-size:14px;color:#555;margin:10px 0}
.question{font-size:16px;font-weight:bold;margin-bottom:10px;text-align:left}
.options label{display:block;background:#f1f1f1;padding:8px;margin:6px 0;border-radius:4px;cursor:pointer;text-align:left}
.button-row{display:flex;justify-content:space-between;margin-top:10px}
button{padding:8px 16px;border:none;border-radius:4px;background:#1976d2;color:#fff;font-size:14px;cursor:pointer}
button:hover{background:#125aa0}
.message{margin-top:10px;font-weight:bold;text-align:center;color:red}
.loading{text-align:center;font-size:16px;padding:20px;color:#1976d2}
.question-nav{display:flex;flex-wrap:wrap;gap:5px;margin-top:15px;justify-content:center}
.question-btn{width:32px;height:32px;border:1px solid #1976d2;background:#f1f1f1;color:#1976d2;text-align:center;line-height:30px;border-radius:4px;cursor:pointer;font-weight:bold;transition:.2s}
.question-btn:hover{background:#e0e0e0}
.question-btn.attempted{background:#4caf50;color:#fff;border-color:#4caf50}
.scoreboard{max-width:500px;margin:30px auto;padding:20px;background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.2);font-size:16px}
.scoreboard h3{margin-top:0;color:#1976d2;text-align:center}
.scoreboard p{margin:5px 0}
.scoreboard button{display:block;margin:15px auto}
</style>
</head>
<body>
<header><span id="examNameLabel" class="exam-name"></span></header>
<div class="container">
<button class="close-btn" onclick="closeTest()">‚úñ</button>
<div class="top-info-row">
  <div id="fullnameLabel"></div>
  <div id="timerDisplay">‚è≥ Time Left: --:--</div>
  <div><strong>Exam Time:</strong> <span id="examTimeInTest"></span> mins</div>
</div>
<div class="quiz-indicator-row">
  <div id="quizIndicator"></div>
  <div id="examNameInTest"></div>
  <div id="modeLabel"></div>
</div>
<div id="quizArea" class="loading">‚è≥ Please wait...</div>
<div id="questionNav" class="question-nav"></div>
</div>
<script>
const code=localStorage.getItem("test_code")||"",mode=(localStorage.getItem("test_mode")||"").toLowerCase(),username=(localStorage.getItem("test_username")||"").trim(),fullname=localStorage.getItem("test_fullname")||"";
document.getElementById("modeLabel").textContent=mode?`Mode: ${mode.charAt(0).toUpperCase()+mode.slice(1)}`:"";
document.getElementById("fullnameLabel").textContent=fullname?`üë§ ${fullname}`:"üë§ Guest User";

let questions=[],currentQ=0,score=0,testDuration=0,maxMarks=0,timerInterval,attempted=[],startTime;

const updateQuizIndicator=()=>{document.getElementById("quizIndicator").textContent=`Question ${currentQ+1} of ${questions.length}`;renderQuestionNav();}
const renderQuestionNav=()=>{const nav=document.getElementById("questionNav");nav.innerHTML="";questions.forEach((_,i)=>{const btn=document.createElement("div");btn.textContent=i+1;btn.className="question-btn";if(attempted[i])btn.classList.add("attempted");btn.onclick=()=>{currentQ=i;mode==="exam"?loadQuestionExamMode():loadQuestionPracticeMode()};nav.appendChild(btn);});};
const renderNavigationButtons=()=>`<div class="button-row"><button onclick="prevQuestion()" ${currentQ===0?'disabled':''}>Previous</button>${currentQ<questions.length-1?`<button onclick="${mode==='exam'?'nextQuestionExam()':'checkPracticeAnswer()'}">Save & Next</button>`:""}<button onclick="endPracticeTest()">Submit Test</button></div>`;
const markAttempted=()=>{attempted[currentQ]=true};

function loadQuestionExamMode(){const q=questions[currentQ];updateQuizIndicator();let html=`<div class="question">${currentQ+1}. ${q.question}</div><div class="options">`;q.options.forEach((opt,idx)=>{html+=`<label><input type="radio" name="option" value="${idx}" ${attempted[currentQ]&&q.selected===idx?'checked':''}> ${opt}</label>`});html+=`</div>`+renderNavigationButtons();document.getElementById("quizArea").innerHTML=html;}
function nextQuestionExam(){const a=document.querySelector("input[name='option']:checked");if(!a){alert("Please select an answer!");return}const idx=parseInt(a.value);questions[currentQ].selected=idx;markAttempted();if(String.fromCharCode(65+idx)===(questions[currentQ].answer||"").trim().toUpperCase())score++;currentQ++;loadQuestionExamMode();}
function prevQuestion(){if(currentQ>0){currentQ--;mode==="exam"?loadQuestionExamMode():loadQuestionPracticeMode();}}
function closeTest(){if(confirm("Are you sure you want to close the test?"))window.history.back();}
function startTimer(mins){let t=mins*60;const update=()=>{const m=Math.floor(t/60),s=t%60;document.getElementById("timerDisplay").textContent=`‚è≥ Time Left: ${m}:${s<10?"0":""}${s}`;if(--t<0){clearInterval(timerInterval);if(mode==="practice")endPracticeTest();else{alert("‚è≥ Time is up! Submitting your test...");submitExam();}}};update();timerInterval=setInterval(update,1000);startTime=Date.now();}
function loadQuestionPracticeMode(){const q=questions[currentQ];updateQuizIndicator();let html=`<div class="question">${currentQ+1}. ${q.question}</div><div class="options">`;q.options.forEach((opt,idx)=>{html+=`<label><input type="radio" name="option" value="${idx}"> ${opt}</label>`});html+=`</div>`+renderNavigationButtons()+`<div class="message" id="practiceMsg"></div>`;document.getElementById("quizArea").innerHTML=html;}
function checkPracticeAnswer(){const a=document.querySelector("input[name='option']:checked");if(!a){alert("Please select an answer!");return}markAttempted();const sel=String.fromCharCode(65+parseInt(a.value)),correct=(questions[currentQ].answer||"").trim().toUpperCase();if(sel===correct){score++;if(currentQ<questions.length-1){currentQ++;loadQuestionPracticeMode()}else endPracticeTest()}else document.getElementById("practiceMsg").textContent="‚ùå Galat Answer! Dubara try karein.";}

function endPracticeTest(){
clearInterval(timerInterval);
const timeTaken=Math.floor((Date.now()-startTime)/60000);
let attemptedCount=attempted.filter(v=>v).length;
let correctCount=score;
let incorrect=attemptedCount-correctCount;
let result="N/A";
if(questions.length>0){result=(score/questions.length)>=0.4?"Pass":"Fail";}
document.getElementById("quizArea").innerHTML=`
<div class="scoreboard">
<h3>üèÜ Practice Test Completed</h3>
<p><strong>Result:</strong> ${result}</p>
<p><strong>Full Name:</strong> ${fullname||"Guest User"}</p>
<p><strong>Max Marks:</strong> ${questions.length}</p>
<p><strong>Obtained Marks:</strong> ${score}</p>
<p><strong>Total Questions:</strong> ${questions.length}</p>
<p><strong>Attempted:</strong> ${attemptedCount}</p>
<p><strong>Correct Answers:</strong> ${correctCount}</p>
<p><strong>Total Incorrect Attempts:</strong> ${incorrect}</p>
<p><strong>Test Time:</strong> ${testDuration} minutes</p>
<p><strong>Time Taken:</strong> ${timeTaken} minutes</p>
<button onclick="closeTest()">Close</button>
</div>`;
}

const backendUrl="https://script.google.com/macros/s/AKfycbx4Bx-4lSDrBsB1_i6E4reHBiKgKP1zhtVWryVoN8L90Bx72JHSNPaA12aV__fYbRA-/exec";
function initTest(){
if(!username){document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">‚ùå User not found. Please login again.</h3>`;return;}
fetch(`${backendUrl}?action=starttestwithpaymentcheck&username=${encodeURIComponent(username)}&testCode=${encodeURIComponent(code)}`)
.then(res=>res.json())
.then(data=>{
document.getElementById("examNameLabel").textContent="";
document.getElementById("examNameInTest").textContent=`Exam Name: ${data.examName||""}`;
testDuration=data.testDuration||0;
document.getElementById("examTimeInTest").textContent=testDuration;
maxMarks=data.maxMarks||0;
questions=data.questions||[];
attempted=new Array(questions.length).fill(false);
if(!questions.length){document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">‚ö† No questions found.</h3>`;return;}
currentQ=0;score=0;startTimer(testDuration);mode==="exam"?loadQuestionExamMode():mode==="practice"?loadQuestionPracticeMode():document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">‚ö† Invalid test mode specified.</h3>`;
})
.catch(err=>{console.error(err);document.getElementById("quizArea").innerHTML=`<h3 style="color:red;">‚ö† Error loading test. Please try again later.</h3>`;});
}
initTest();
</script>
</body>
</html>
